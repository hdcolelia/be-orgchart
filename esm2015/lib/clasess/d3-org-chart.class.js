//#region 
// Desarrollado en base a: 
//  https://bl.ocks.org/bumbeishvili/09a03b81ae788d2d14f750afe59eb7de
//  https://github.com/bumbeishvili/d3-organization-chart
//#endregion
import * as d3 from 'd3';
import { Subject, fromEvent } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { NodeItemParser } from './../components/@items/basic/item-basic';
export class D3OrgChart {
    constructor(prContainer, prOptions) {
        var _a, _b;
        //#region Default Options
        this.options = {
            backgroundColor: '#03A3C5',
            nodeParser: new NodeItemParser(),
            data: [],
            defaultFont: 'Tahoma'
        };
        this._data = [];
        //#endregion
        this.currentZoom = 1;
        this._nodeSize = {
            width: 250,
            height: 200
        };
        //#region Events
        // node click
        this.onNodeClick = new Subject();
        const me = this;
        // init container
        me.container = d3.select(prContainer);
        //If Data argument passed - then set it
        if ((_a = prOptions) === null || _a === void 0 ? void 0 : _a.data)
            me._data = prOptions.data;
        // setting parser
        me._nodeParser = ((_b = prOptions) === null || _b === void 0 ? void 0 : _b.nodeParser) || me.options.nodeParser;
        // applying options
        me.options = Object.assign(me.options, prOptions);
        // monitor resize
        fromEvent(window, 'resize')
            .pipe(debounceTime(300)).subscribe(() => {
            // HDC - VER this.prepareCanvas();
            this.render();
        });
    }
    get data() {
        return this._data || [];
    }
    set data(data) {
        this._data = data;
        // this.render()
    }
    get nodeParser() {
        return this._nodeParser;
    }
    set nodeParser(parser) {
        this._nodeParser = parser;
        // this.render();
    }
    get nodeSize() {
        return this._nodeSize;
    }
    set nodeSize(prSize) {
        this._nodeSize = prSize;
    }
    render() {
        const me = this;
        // preparing svg
        me.prepareCanvas();
        // if no data then return
        if (!me.data.length)
            return;
        // preparing data
        me.prepareData();
        // showing nodes
        me.showNodes();
        return this;
    }
    // preparing canvas
    prepareCanvas() {
        const me = this;
        //Drawing containers
        const containerRect = me.container.node().getBoundingClientRect();
        me.svg = me.container.selectAll('svg')
            .data([{ id: 'svg' }], (d) => d.id)
            .join(enter => enter
            .append('svg')
            .attr('class', 'svg-chart-container')
            .attr('font-family', me.options.defaultFont)
            .call(d3.zoom().on("zoom", d => this.zoomed()))
            .attr('cursor', 'move')
            .style('background-color', me.options.backgroundColor), update => update
            .attr('width', containerRect.width)
            .attr('height', containerRect.height));
        //Add container g element
        me.chart = me.svg.selectAll('g.chart')
            .data([{ id: 'chart' }], (d) => d.id)
            .join(enter => enter
            .append('g')
            .attr('class', 'chart')
            .attr('transform', `translate(0,0)`), update => update);
        // Add one more container g element, for better positioning controls
        me.centerG = me.chart.selectAll('g.center-group')
            .data([{ id: 'center-group' }], (d) => d.id)
            .join(enter => enter.append('g')
            .attr('class', 'center-group'), update => update
            .attr('transform', `translate(${containerRect.width / 2},${this._nodeSize.height}) scale(${this.currentZoom})`));
    }
    // preparing data
    prepareData() {
        const me = this;
        // if no data return 
        if (!me.data.length)
            return;
        // Convert flat data to hierarchical
        me.root = d3.stratify()
            .id(({ nodeId }) => nodeId)
            .parentId(({ parentNodeId }) => parentNodeId)(me.data);
        // preparing treemap
        const containerRect = me.container.node().getBoundingClientRect();
        me.treemap = d3.tree().size([containerRect.width || 250, containerRect.height])
            .nodeSize([this._nodeSize.width + 100, this._nodeSize.height + 100]);
        me.allNodes = me.treemap(me.root).descendants();
    }
    // showing nodes
    showNodes() {
        const me = this;
        //  Assigns the x and y position for the nodes
        const treeData = me.treemap(me.root);
        // select nodes from center group
        // it is necesary for scope 
        const drawNodes = (container, nodes) => me.nodeParser.drawNodes(container, nodes);
        const nodes = treeData.descendants()
            .filter(current => !current.parent
            || current.parent.data.expanded);
        // rendering nodes
        const nodeStartPosition = (d) => {
            if (!d.parent)
                return `translate(${d.x - (me.nodeParser.width / 2)},${d.y})`;
            return `translate(${d.parent.x - (me.nodeParser.width / 2)},${d.parent.y})`;
        };
        const nodePosition = (d) => `translate(${d.x - (me.nodeParser.width / 2)},${d.y})`;
        me.centerG.selectAll('g.node')
            .data(nodes, (d) => d.data.nodeId)
            .join(enter => enter
            .append('g')
            .attr('class', 'node')
            .attr('transform', nodeStartPosition)
            .call(drawNodes, nodes)
            .on('click', (node) => {
            me.expand(node);
            me.onNodeClick.next({ id: node.data.nodeId, node: node.data });
        }), update => update, exit => exit
            .transition()
            .duration(600)
            .attr('transform', nodeStartPosition)
            .style("opacity", 0)
            .remove())
            .transition().duration(600)
            .attr('transform', nodePosition);
        // rendering links
        const pathStartingDiagonal = (d) => {
            const target = { x: d.parent.x, y: d.parent.y + me.nodeParser.height };
            return this.diagonal(target, target);
        };
        const pathDiagonal = (d) => {
            const target = { x: d.parent.x, y: d.parent.y + me.nodeParser.height };
            return this.diagonal(d, target);
        };
        me.centerG.selectAll('path.link')
            .data(nodes.slice(1), (d) => d.data.nodeId)
            .join(enter => enter
            .insert('path', 'g')
            .attr('class', 'link')
            .attr('fill', 'none')
            .attr('stroke', 'blue')
            .attr('stroke-width', 2)
            .attr('d', pathStartingDiagonal), update => update, exit => exit
            .transition().duration(600)
            .attr('d', pathStartingDiagonal)
            .remove())
            .transition().duration(600)
            .attr('d', pathDiagonal);
    }
    // Zoom handler function
    zoomed() {
        const me = this;
        // Saving d3 event's transform object
        me.lastTransform = d3.event.transform;
        // Reposition and rescale chart accordingly
        me.chart.attr('transform', me.lastTransform);
    }
    _onNodeClick(nodeId, node) {
        this.onNodeClick.next({ id: nodeId, node: node });
    }
    //#endregion
    //drawNode(prNode: d3.HierarchyPointNode<ID3Node>) {
    //  const me = this;
    //  me.nodeParser.draw(me.centerG, prNode);
    //}
    // Generate custom diagonal - play with it here - https://observablehq.com/@bumbeishvili/curved-edges?collection=@bumbeishvili/work-components
    diagonal(s, t) {
        // Calculate some variables based on source and target (s,t) coordinates
        const x = s.x;
        const y = s.y;
        const ex = t.x;
        const ey = t.y;
        let xrvs = ex - x < 0 ? -1 : 1;
        let yrvs = ey - y < 0 ? -1 : 1;
        let rdef = 35;
        let rInitial = Math.abs(ex - x) / 2 < rdef ? Math.abs(ex - x) / 2 : rdef;
        let r = Math.abs(ey - y) / 2 < rInitial ? Math.abs(ey - y) / 2 : rInitial;
        let h = Math.abs(ey - y) / 2 - r;
        let w = Math.abs(ex - x) - r * 2;
        // Build the path
        const path = `
            M ${x} ${y}
            L ${x} ${y + h * yrvs}
            C  ${x} ${y + h * yrvs + r * yrvs} ${x} ${y + h * yrvs + r * yrvs} ${x + r * xrvs} ${y + h * yrvs + r * yrvs}
            L ${x + w * xrvs + r * xrvs} ${y + h * yrvs + r * yrvs}
            C ${ex}  ${y + h * yrvs + r * yrvs} ${ex}  ${y + h * yrvs + r * yrvs} ${ex} ${ey - h * yrvs}
            L ${ex} ${ey}
          `;
        // Return result
        return path;
    }
    expand(node) {
        const me = this;
        const expanded = node.data.expanded;
        node.data.expanded = !expanded;
        const expand = (children, expanded) => {
            (children || [])
                .forEach(current => {
                current.data.hidden = !expanded;
                expand(current.children, expanded);
            });
        };
        expand(node.children, expanded);
        me.render();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZDMtb3JnLWNoYXJ0LmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYmUtZDMtb3JnY2hhcnQvIiwic291cmNlcyI6WyJsaWIvY2xhc2Vzcy9kMy1vcmctY2hhcnQuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsVUFBVTtBQUNWLDJCQUEyQjtBQUMzQixxRUFBcUU7QUFDckUseURBQXlEO0FBQ3pELFlBQVk7QUFFWixPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUV6QixPQUFPLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBY3pFLE1BQU0sT0FBTyxVQUFVO0lBK0RyQixZQUFZLFdBQXdCLEVBQUUsU0FBOEI7O1FBOURwRSx5QkFBeUI7UUFDZixZQUFPLEdBQXVCO1lBQ3RDLGVBQWUsRUFBRSxTQUFTO1lBQzFCLFVBQVUsRUFBRSxJQUFJLGNBQWMsRUFBRTtZQUNoQyxJQUFJLEVBQUUsRUFBRTtZQUNSLFdBQVcsRUFBRSxRQUFRO1NBQ3RCLENBQUE7UUFpQlMsVUFBSyxHQUFjLEVBQUUsQ0FBQztRQW9CaEMsWUFBWTtRQUVaLGdCQUFXLEdBQVcsQ0FBQyxDQUFDO1FBRWQsY0FBUyxHQUFVO1lBQzNCLEtBQUssRUFBRSxHQUFHO1lBQ1YsTUFBTSxFQUFFLEdBQUc7U0FDWixDQUFDO1FBd05GLGdCQUFnQjtRQUNoQixhQUFhO1FBQ2IsZ0JBQVcsR0FBMkMsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQTdNbEUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBRWhCLGlCQUFpQjtRQUNqQixFQUFFLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdEMsdUNBQXVDO1FBQ3ZDLFVBQUksU0FBUywwQ0FBRSxJ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QUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFDZCxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztRQUN6RSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUMxRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakMsaUJBQWlCO1FBQ2pCLE1BQU0sSUFBSSxHQUFHO2dCQUNELENBQUMsSUFBSSxDQUFDO2dCQUNOLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUk7aUJBQ2hCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJO2dCQUN4RyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJO2dCQUNsRCxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJO2dCQUN2RixFQUFFLElBQUksRUFBRTtXQUNiLENBQUE7UUFDUCxnQkFBZ0I7UUFDaEIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQW9DO1FBQ3pDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUUvQixNQUFNLE1BQU0sR0FBRyxDQUFDLFFBQTBDLEVBQUUsUUFBaUIsRUFBRSxFQUFFO1lBQy9FLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztpQkFDYixPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUNoQyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQTtRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2hDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbIi8vI3JlZ2lvbiBcclxuLy8gRGVzYXJyb2xsYWRvIGVuIGJhc2UgYTogXHJcbi8vICBodHRwczovL2JsLm9ja3Mub3JnL2J1bWJlaXNodmlsaS8wOWEwM2I4MWFlNzg4ZDJkMTRmNzUwYWZlNTllYjdkZVxyXG4vLyAgaHR0cHM6Ly9naXRodWIuY29tL2J1bWJlaXNodmlsaS9kMy1vcmdhbml6YXRpb24tY2hhcnRcclxuLy8jZW5kcmVnaW9uXHJcblxyXG5pbXBvcnQgKiBhcyBkMyBmcm9tICdkMyc7XHJcbmltcG9ydCB7IElEM05vZGUgfSBmcm9tICcuLi9pbnRlcmZhY2VzJztcclxuaW1wb3J0IHsgU3ViamVjdCwgZnJvbUV2ZW50IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTm9kZUl0ZW1QYXJzZXIgfSBmcm9tICcuLy4uL2NvbXBvbmVudHMvQGl0ZW1zL2Jhc2ljL2l0ZW0tYmFzaWMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJRDNPcmdDaGFydE9wdGlvbnMge1xyXG4gIG5vZGVQYXJzZXI/OiBOb2RlSXRlbVBhcnNlcjtcclxuICBkYXRhPzogSUQzTm9kZVtdO1xyXG4gIGJhY2tncm91bmRDb2xvcj86IHN0cmluZztcclxuICBkZWZhdWx0Rm9udD86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJU2l6ZSB7XHJcbiAgd2lkdGg6IG51bWJlcjtcclxuICBoZWlnaHQ6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEQzT3JnQ2hhcnQge1xyXG4gIC8vI3JlZ2lvbiBEZWZhdWx0IE9wdGlvbnNcclxuICBwcm90ZWN0ZWQgb3B0aW9uczogSUQzT3JnQ2hhcnRPcHRpb25zID0ge1xyXG4gICAgYmFja2dyb3VuZENvbG9yOiAnIzAzQTNDNScsXHJcbiAgICBub2RlUGFyc2VyOiBuZXcgTm9kZUl0ZW1QYXJzZXIoKSxcclxuICAgIGRhdGE6IFtdLFxyXG4gICAgZGVmYXVsdEZvbnQ6ICdUYWhvbWEnXHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG5cclxuICAvLyNyZWdpb24gU1ZHIGNvbXBvZW5udHNcclxuICBwcm90ZWN0ZWQgY29udGFpbmVyOiBkMy5TZWxlY3Rpb248SFRNTEVsZW1lbnQsIGFueSwgYW55LCBhbnk+O1xyXG4gIHByb3RlY3RlZCBzdmc6IGQzLlNlbGVjdGlvbjxhbnksIGFueSwgYW55LCBhbnk+O1xyXG4gIHByb3RlY3RlZCBjaGFydDogZDMuU2VsZWN0aW9uPGFueSwgYW55LCBhbnksIGFueT47XHJcbiAgcHJvdGVjdGVkIGNlbnRlckc6IGQzLlNlbGVjdGlvbjxhbnksIGFueSwgYW55LCBhbnk+O1xyXG5cclxuICBwcm90ZWN0ZWQgZGVmczogYW55O1xyXG4gIHByb3RlY3RlZCBsYXN0VHJhbnNmb3JtOiBhbnk7XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vI3JlZ2lvbiBEQVRBXHJcbiAgcHJvdGVjdGVkIHJvb3Q6IGQzLkhpZXJhcmNoeVBvaW50Tm9kZTxJRDNOb2RlPjtcclxuICBwcm90ZWN0ZWQgYWxsTm9kZXM6IGFueTtcclxuXHJcbiAgcHJvdGVjdGVkIF9kYXRhOiBJRDNOb2RlW10gPSBbXTtcclxuICBnZXQgZGF0YSgpOiBJRDNOb2RlW10ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2RhdGEgfHwgW107XHJcbiAgfVxyXG5cclxuICBzZXQgZGF0YShkYXRhOiBJRDNOb2RlW10pIHtcclxuICAgIHRoaXMuX2RhdGEgPSBkYXRhO1xyXG4gICAgLy8gdGhpcy5yZW5kZXIoKVxyXG4gIH1cclxuICAvLyNlbmRyZWdpb25cclxuXHJcbiAgLy8jcmVnaW9uICBOT0RFIFBBUlNFUlxyXG4gIHByb3RlY3RlZCBfbm9kZVBhcnNlcjogTm9kZUl0ZW1QYXJzZXI7XHJcbiAgZ2V0IG5vZGVQYXJzZXIoKTogTm9kZUl0ZW1QYXJzZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX25vZGVQYXJzZXI7XHJcbiAgfVxyXG4gIHNldCBub2RlUGFyc2VyKHBhcnNlcjogTm9kZUl0ZW1QYXJzZXIpIHtcclxuICAgIHRoaXMuX25vZGVQYXJzZXIgPSBwYXJzZXI7XHJcbiAgICAvLyB0aGlzLnJlbmRlcigpO1xyXG4gIH1cclxuICAvLyNlbmRyZWdpb25cclxuXHJcbiAgY3VycmVudFpvb206IG51bWJlciA9IDE7XHJcblxyXG4gIHByb3RlY3RlZCBfbm9kZVNpemU6IElTaXplID0ge1xyXG4gICAgd2lkdGg6IDI1MCxcclxuICAgIGhlaWdodDogMjAwXHJcbiAgfTtcclxuXHJcbiAgZ2V0IG5vZGVTaXplKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX25vZGVTaXplO1xyXG4gIH1cclxuXHJcbiAgc2V0IG5vZGVTaXplKHByU2l6ZTogSVNpemUpIHtcclxuICAgIHRoaXMuX25vZGVTaXplID0gcHJTaXplO1xyXG4gIH1cclxuXHJcbiAgdHJlZW1hcDogZDMuVHJlZUxheW91dDxJRDNOb2RlPjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJDb250YWluZXI6IEhUTUxFbGVtZW50LCBwck9wdGlvbnM/OiBJRDNPcmdDaGFydE9wdGlvbnMpIHtcclxuICAgIGNvbnN0IG1lID0gdGhpcztcclxuXHJcbiAgICAvLyBpbml0IGNvbnRhaW5lclxyXG4gICAgbWUuY29udGFpbmVyID0gZDMuc2VsZWN0KHByQ29udGFpbmVyKTtcclxuXHJcbiAgICAvL0lmIERhdGEgYXJndW1lbnQgcGFzc2VkIC0gdGhlbiBzZXQgaXRcclxuICAgIGlmIChwck9wdGlvbnM/LmRhdGEpIG1lLl9kYXRhID0gcHJPcHRpb25zLmRhdGE7XHJcblxyXG4gICAgLy8gc2V0dGluZyBwYXJzZXJcclxuICAgIG1lLl9ub2RlUGFyc2VyID0gcHJPcHRpb25zPy5ub2RlUGFyc2VyIHx8IG1lLm9wdGlvbnMubm9kZVBhcnNlcjtcclxuXHJcbiAgICAvLyBhcHBseWluZyBvcHRpb25zXHJcbiAgICBtZS5vcHRpb25zID0gT2JqZWN0LmFzc2lnbihtZS5vcHRpb25zLCBwck9wdGlvbnMpO1xyXG5cclxuICAgIC8vIG1vbml0b3IgcmVzaXplXHJcbiAgICBmcm9tRXZlbnQod2luZG93LCAncmVzaXplJylcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMClcclxuICAgICAgKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgLy8gSERDIC0gVkVSIHRoaXMucHJlcGFyZUNhbnZhcygpO1xyXG4gICAgICAgICAgdGhpcy5yZW5kZXIoKTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICB9XHJcblxyXG4gIHJlbmRlcigpIHtcclxuICAgIGNvbnN0IG1lID0gdGhpcztcclxuICAgIC8vIHByZXBhcmluZyBzdmdcclxuICAgIG1lLnByZXBhcmVDYW52YXMoKTtcclxuXHJcbiAgICAvLyBpZiBubyBkYXRhIHRoZW4gcmV0dXJuXHJcbiAgICBpZiAoIW1lLmRhdGEubGVuZ3RoKSByZXR1cm47XHJcblxyXG4gICAgLy8gcHJlcGFyaW5nIGRhdGFcclxuICAgIG1lLnByZXBhcmVEYXRhKCk7XHJcblxyXG4gICAgLy8gc2hvd2luZyBub2Rlc1xyXG4gICAgbWUuc2hvd05vZGVzKCk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIC8vIHByZXBhcmluZyBjYW52YXNcclxuICBwcm90ZWN0ZWQgcHJlcGFyZUNhbnZhcygpIHtcclxuICAgIGNvbnN0IG1lID0gdGhpcztcclxuXHJcbiAgICAvL0RyYXdpbmcgY29udGFpbmVyc1xyXG4gICAgY29uc3QgY29udGFpbmVyUmVjdCA9IG1lLmNvbnRhaW5lci5ub2RlKCkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICBtZS5zdmcgPSBtZS5jb250YWluZXIuc2VsZWN0QWxsKCdzdmcnKVxyXG4gICAgICAuZGF0YShbeyBpZDogJ3N2ZycgfV0sIChkOiB7IGlkOiBzdHJpbmcgfSkgPT4gZC5pZClcclxuICAgICAgLmpvaW4oXHJcbiAgICAgICAgZW50ZXIgPT4gZW50ZXJcclxuICAgICAgICAgIC5hcHBlbmQoJ3N2ZycpXHJcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnc3ZnLWNoYXJ0LWNvbnRhaW5lcicpXHJcbiAgICAgICAgICAuYXR0cignZm9udC1mYW1pbHknLCBtZS5vcHRpb25zLmRlZmF1bHRGb250KVxyXG4gICAgICAgICAgLmNhbGwoZDMuem9vbSgpLm9uKFwiem9vbVwiLCBkID0+IHRoaXMuem9vbWVkKCkpKVxyXG4gICAgICAgICAgLmF0dHIoJ2N1cnNvcicsICdtb3ZlJylcclxuICAgICAgICAgIC5zdHlsZSgnYmFja2dyb3VuZC1jb2xvcicsIG1lLm9wdGlvbnMuYmFja2dyb3VuZENvbG9yKSxcclxuICAgICAgICB1cGRhdGUgPT5cclxuICAgICAgICAgIHVwZGF0ZVxyXG4gICAgICAgICAgICAuYXR0cignd2lkdGgnLCBjb250YWluZXJSZWN0LndpZHRoKVxyXG4gICAgICAgICAgICAuYXR0cignaGVpZ2h0JywgY29udGFpbmVyUmVjdC5oZWlnaHQpXHJcbiAgICAgICk7XHJcbiAgICAvL0FkZCBjb250YWluZXIgZyBlbGVtZW50XHJcbiAgICBtZS5jaGFydCA9IG1lLnN2Zy5zZWxlY3RBbGwoJ2cuY2hhcnQnKVxyXG4gICAgICAuZGF0YShbeyBpZDogJ2NoYXJ0JyB9XSwgKGQ6IHsgaWQ6IHN0cmluZyB9KSA9PiBkLmlkKVxyXG4gICAgICAuam9pbihcclxuICAgICAgICBlbnRlciA9PiBlbnRlclxyXG4gICAgICAgICAgLmFwcGVuZCgnZycpXHJcbiAgICAgICAgICAuYXR0cignY2xhc3MnLCAnY2hhcnQnKVxyXG4gICAgICAgICAgLmF0dHIoJ3RyYW5zZm9ybScsIGB0cmFuc2xhdGUoMCwwKWApLFxyXG4gICAgICAgIHVwZGF0ZSA9PiB1cGRhdGVcclxuICAgICAgKVxyXG5cclxuICAgIC8vIEFkZCBvbmUgbW9yZSBjb250YWluZXIgZyBlbGVtZW50LCBmb3IgYmV0dGVyIHBvc2l0aW9uaW5nIGNvbnRyb2xzXHJcbiAgICBtZS5jZW50ZXJHID0gbWUuY2hhcnQuc2VsZWN0QWxsKCdnLmNlbnRlci1ncm91cCcpXHJcbiAgICAgIC5kYXRhKFt7IGlkOiAnY2VudGVyLWdyb3VwJyB9XSwgKGQ6IHsgaWQ6IHN0cmluZyB9KSA9PiBkLmlkKVxyXG4gICAgICAuam9pbihcclxuICAgICAgICBlbnRlciA9PiBlbnRlci5hcHBlbmQoJ2cnKVxyXG4gICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ2NlbnRlci1ncm91cCcpLFxyXG4gICAgICAgIHVwZGF0ZSA9PlxyXG4gICAgICAgICAgdXBkYXRlXHJcbiAgICAgICAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCBgdHJhbnNsYXRlKCR7Y29udGFpbmVyUmVjdC53aWR0aCAvIDJ9LCR7dGhpcy5fbm9kZVNpemUuaGVpZ2h0fSkgc2NhbGUoJHt0aGlzLmN1cnJlbnRab29tfSlgKVxyXG4gICAgICApXHJcbiAgfVxyXG5cclxuICAvLyBwcmVwYXJpbmcgZGF0YVxyXG4gIHByb3RlY3RlZCBwcmVwYXJlRGF0YSgpIHtcclxuICAgIGNvbnN0IG1lID0gdGhpcztcclxuXHJcbiAgICAvLyBpZiBubyBkYXRhIHJldHVybiBcclxuICAgIGlmICghbWUuZGF0YS5sZW5ndGgpIHJldHVybjtcclxuXHJcbiAgICAvLyBDb252ZXJ0IGZsYXQgZGF0YSB0byBoaWVyYXJjaGljYWxcclxuICAgIG1lLnJvb3QgPSBkMy5zdHJhdGlmeTxJRDNOb2RlPigpXHJcbiAgICAgIC5pZCgoeyBub2RlSWQgfSkgPT4gbm9kZUlkKVxyXG4gICAgICAucGFyZW50SWQoKHsgcGFyZW50Tm9kZUlkIH0pID0+IHBhcmVudE5vZGVJZClcclxuICAgICAgKG1lLmRhdGEpIGFzIGQzLkhpZXJhcmNoeVBvaW50Tm9kZTxJRDNOb2RlPjtcclxuXHJcblxyXG4gICAgLy8gcHJlcGFyaW5nIHRyZWVtYXBcclxuICAgIGNvbnN0IGNvbnRhaW5lclJlY3QgPSBtZS5jb250YWluZXIubm9kZSgpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgbWUudHJlZW1hcCA9IGQzLnRyZWU8SUQzTm9kZT4oKS5zaXplKFtjb250YWluZXJSZWN0LndpZHRoIHx8IDI1MCwgY29udGFpbmVyUmVjdC5oZWlnaHRdKVxyXG4gICAgICAubm9kZVNpemUoW3RoaXMuX25vZGVTaXplLndpZHRoICsgMTAwLCB0aGlzLl9ub2RlU2l6ZS5oZWlnaHQgKyAxMDBdKTtcclxuXHJcbiAgICBtZS5hbGxOb2RlcyA9IG1lLnRyZWVtYXAobWUucm9vdCkuZGVzY2VuZGFudHMoKTtcclxuICB9XHJcblxyXG4gIC8vIHNob3dpbmcgbm9kZXNcclxuICBwcm90ZWN0ZWQgc2hvd05vZGVzKCkge1xyXG4gICAgY29uc3QgbWUgPSB0aGlzO1xyXG4gICAgLy8gIEFzc2lnbnMgdGhlIHggYW5kIHkgcG9zaXRpb24gZm9yIHRoZSBub2Rlc1xyXG4gICAgY29uc3QgdHJlZURhdGEgPSBtZS50cmVlbWFwKG1lLnJvb3QpO1xyXG5cclxuICAgIC8vIHNlbGVjdCBub2RlcyBmcm9tIGNlbnRlciBncm91cFxyXG5cclxuICAgIC8vIGl0IGlzIG5lY2VzYXJ5IGZvciBzY29wZSBcclxuICAgIGNvbnN0IGRyYXdOb2RlcyA9IChjb250YWluZXIsIG5vZGVzKSA9PiBtZS5ub2RlUGFyc2VyLmRyYXdOb2Rlcyhjb250YWluZXIsIG5vZGVzKTtcclxuXHJcbiAgICBjb25zdCBub2RlcyA9IHRyZWVEYXRhLmRlc2NlbmRhbnRzKClcclxuICAgICAgLmZpbHRlcihjdXJyZW50ID0+XHJcbiAgICAgICAgIWN1cnJlbnQucGFyZW50XHJcbiAgICAgICAgfHwgY3VycmVudC5wYXJlbnQuZGF0YS5leHBhbmRlZFxyXG4gICAgICApO1xyXG5cclxuICAgIC8vIHJlbmRlcmluZyBub2Rlc1xyXG4gICAgY29uc3Qgbm9kZVN0YXJ0UG9zaXRpb24gPSAoZDogZDMuSGllcmFyY2h5UG9pbnROb2RlPElEM05vZGU+KSA9PiB7XHJcbiAgICAgIGlmICghZC5wYXJlbnQpIHJldHVybiBgdHJhbnNsYXRlKCR7ZC54IC0gKG1lLm5vZGVQYXJzZXIud2lkdGggLyAyKX0sJHtkLnl9KWA7XHJcbiAgICAgIHJldHVybiBgdHJhbnNsYXRlKCR7ZC5wYXJlbnQueCAtIChtZS5ub2RlUGFyc2VyLndpZHRoIC8gMil9LCR7ZC5wYXJlbnQueX0pYFxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5vZGVQb3NpdGlvbiA9IChkOiBkMy5IaWVyYXJjaHlQb2ludE5vZGU8SUQzTm9kZT4pID0+XHJcbiAgICAgIGB0cmFuc2xhdGUoJHtkLnggLSAobWUubm9kZVBhcnNlci53aWR0aCAvIDIpfSwke2QueX0pYDtcclxuXHJcbiAgICBtZS5jZW50ZXJHLnNlbGVjdEFsbCgnZy5ub2RlJylcclxuICAgICAgLmRhdGEobm9kZXMsIChkOiBkMy5IaWVyYXJjaHlQb2ludE5vZGU8SUQzTm9kZT4pID0+IGQuZGF0YS5ub2RlSWQpXHJcbiAgICAgIC5qb2luKFxyXG4gICAgICAgIGVudGVyID0+XHJcbiAgICAgICAgICBlbnRlclxyXG4gICAgICAgICAgICAuYXBwZW5kKCdnJylcclxuICAgICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ25vZGUnKVxyXG4gICAgICAgICAgICAuYXR0cigndHJhbnNmb3JtJywgbm9kZVN0YXJ0UG9zaXRpb24pXHJcbiAgICAgICAgICAgIC5jYWxsKGRyYXdOb2Rlcywgbm9kZXMpXHJcbiAgICAgICAgICAgIC5vbignY2xpY2snLCAobm9kZSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICBtZS5leHBhbmQobm9kZSk7XHJcblxyXG4gICAgICAgICAgICAgIG1lLm9uTm9kZUNsaWNrLm5leHQoeyBpZDogbm9kZS5kYXRhLm5vZGVJZCwgbm9kZTogbm9kZS5kYXRhIH0pO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICB1cGRhdGUgPT4gdXBkYXRlLFxyXG4gICAgICAgIGV4aXQgPT5cclxuICAgICAgICAgIGV4aXRcclxuICAgICAgICAgICAgLnRyYW5zaXRpb24oKVxyXG4gICAgICAgICAgICAuZHVyYXRpb24oNjAwKVxyXG4gICAgICAgICAgICAuYXR0cigndHJhbnNmb3JtJywgbm9kZVN0YXJ0UG9zaXRpb24pXHJcbiAgICAgICAgICAgIC5zdHlsZShcIm9wYWNpdHlcIiwgMClcclxuICAgICAgICAgICAgLnJlbW92ZSgpXHJcbiAgICAgIClcclxuICAgICAgLnRyYW5zaXRpb24oKS5kdXJhdGlvbig2MDApXHJcbiAgICAgIC5hdHRyKCd0cmFuc2Zvcm0nLCBub2RlUG9zaXRpb24pO1xyXG5cclxuICAgIC8vIHJlbmRlcmluZyBsaW5rc1xyXG5cclxuICAgIGNvbnN0IHBhdGhTdGFydGluZ0RpYWdvbmFsID0gKGQ6IGQzLkhpZXJhcmNoeVBvaW50Tm9kZTxJRDNOb2RlPikgPT4ge1xyXG4gICAgICBjb25zdCB0YXJnZXQgPSB7IHg6IGQucGFyZW50LngsIHk6IGQucGFyZW50LnkgKyBtZS5ub2RlUGFyc2VyLmhlaWdodCB9O1xyXG4gICAgICByZXR1cm4gdGhpcy5kaWFnb25hbCh0YXJnZXQsIHRhcmdldClcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYXRoRGlhZ29uYWwgPSAoZDogZDMuSGllcmFyY2h5UG9pbnROb2RlPElEM05vZGU+KSA9PiB7XHJcbiAgICAgIGNvbnN0IHRhcmdldCA9IHsgeDogZC5wYXJlbnQueCwgeTogZC5wYXJlbnQueSArIG1lLm5vZGVQYXJzZXIuaGVpZ2h0IH07XHJcbiAgICAgIHJldHVybiB0aGlzLmRpYWdvbmFsKGQsIHRhcmdldClcclxuICAgIH1cclxuXHJcbiAgICBtZS5jZW50ZXJHLnNlbGVjdEFsbCgncGF0aC5saW5rJylcclxuICAgICAgLmRhdGEobm9kZXMuc2xpY2UoMSksIChkOiBkMy5IaWVyYXJjaHlQb2ludE5vZGU8SUQzTm9kZT4pID0+IGQuZGF0YS5ub2RlSWQpXHJcbiAgICAgIC5qb2luKFxyXG4gICAgICAgIGVudGVyID0+XHJcbiAgICAgICAgICBlbnRlclxyXG4gICAgICAgICAgICAuaW5zZXJ0KCdwYXRoJywgJ2cnKVxyXG4gICAgICAgICAgICAuYXR0cignY2xhc3MnLCAnbGluaycpXHJcbiAgICAgICAgICAgIC5hdHRyKCdmaWxsJywgJ25vbmUnKVxyXG4gICAgICAgICAgICAuYXR0cignc3Ryb2tlJywgJ2JsdWUnKVxyXG4gICAgICAgICAgICAuYXR0cignc3Ryb2tlLXdpZHRoJywgMilcclxuICAgICAgICAgICAgLmF0dHIoJ2QnLCBwYXRoU3RhcnRpbmdEaWFnb25hbCksXHJcbiAgICAgICAgdXBkYXRlID0+IHVwZGF0ZSxcclxuICAgICAgICBleGl0ID0+XHJcbiAgICAgICAgICBleGl0XHJcbiAgICAgICAgICAgIC50cmFuc2l0aW9uKCkuZHVyYXRpb24oNjAwKVxyXG4gICAgICAgICAgICAuYXR0cignZCcsIHBhdGhTdGFydGluZ0RpYWdvbmFsKVxyXG4gICAgICAgICAgICAucmVtb3ZlKClcclxuICAgICAgKVxyXG4gICAgICAudHJhbnNpdGlvbigpLmR1cmF0aW9uKDYwMClcclxuICAgICAgLmF0dHIoJ2QnLCBwYXRoRGlhZ29uYWwpO1xyXG4gIH1cclxuXHJcbiAgLy8gWm9vbSBoYW5kbGVyIGZ1bmN0aW9uXHJcbiAgem9vbWVkKCkge1xyXG4gICAgY29uc3QgbWUgPSB0aGlzO1xyXG4gICAgLy8gU2F2aW5nIGQzIGV2ZW50J3MgdHJhbnNmb3JtIG9iamVjdFxyXG4gICAgbWUubGFzdFRyYW5zZm9ybSA9IGQzLmV2ZW50LnRyYW5zZm9ybTtcclxuICAgIC8vIFJlcG9zaXRpb24gYW5kIHJlc2NhbGUgY2hhcnQgYWNjb3JkaW5nbHlcclxuICAgIG1lLmNoYXJ0LmF0dHIoJ3RyYW5zZm9ybScsIG1lLmxhc3RUcmFuc2Zvcm0pO1xyXG4gIH1cclxuICAvLyNyZWdpb24gRXZlbnRzXHJcbiAgLy8gbm9kZSBjbGlja1xyXG4gIG9uTm9kZUNsaWNrOiBTdWJqZWN0PHsgaWQ6IHN0cmluZywgbm9kZTogSUQzTm9kZSB9PiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgcHJvdGVjdGVkIF9vbk5vZGVDbGljayhub2RlSWQ6IHN0cmluZywgbm9kZTogSUQzTm9kZSkge1xyXG4gICAgdGhpcy5vbk5vZGVDbGljay5uZXh0KHsgaWQ6IG5vZGVJZCwgbm9kZTogbm9kZSB9KTtcclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vZHJhd05vZGUocHJOb2RlOiBkMy5IaWVyYXJjaHlQb2ludE5vZGU8SUQzTm9kZT4pIHtcclxuICAvLyAgY29uc3QgbWUgPSB0aGlzO1xyXG4gIC8vICBtZS5ub2RlUGFyc2VyLmRyYXcobWUuY2VudGVyRywgcHJOb2RlKTtcclxuICAvL31cclxuXHJcblxyXG4gIC8vIEdlbmVyYXRlIGN1c3RvbSBkaWFnb25hbCAtIHBsYXkgd2l0aCBpdCBoZXJlIC0gaHR0cHM6Ly9vYnNlcnZhYmxlaHEuY29tL0BidW1iZWlzaHZpbGkvY3VydmVkLWVkZ2VzP2NvbGxlY3Rpb249QGJ1bWJlaXNodmlsaS93b3JrLWNvbXBvbmVudHNcclxuICBkaWFnb25hbChzLCB0KSB7XHJcblxyXG4gICAgLy8gQ2FsY3VsYXRlIHNvbWUgdmFyaWFibGVzIGJhc2VkIG9uIHNvdXJjZSBhbmQgdGFyZ2V0IChzLHQpIGNvb3JkaW5hdGVzXHJcbiAgICBjb25zdCB4ID0gcy54O1xyXG4gICAgY29uc3QgeSA9IHMueTtcclxuICAgIGNvbnN0IGV4ID0gdC54O1xyXG4gICAgY29uc3QgZXkgPSB0Lnk7XHJcbiAgICBsZXQgeHJ2cyA9IGV4IC0geCA8IDAgPyAtMSA6IDE7XHJcbiAgICBsZXQgeXJ2cyA9IGV5IC0geSA8IDAgPyAtMSA6IDE7XHJcbiAgICBsZXQgcmRlZiA9IDM1O1xyXG4gICAgbGV0IHJJbml0aWFsID0gTWF0aC5hYnMoZXggLSB4KSAvIDIgPCByZGVmID8gTWF0aC5hYnMoZXggLSB4KSAvIDIgOiByZGVmO1xyXG4gICAgbGV0IHIgPSBNYXRoLmFicyhleSAtIHkpIC8gMiA8IHJJbml0aWFsID8gTWF0aC5hYnMoZXkgLSB5KSAvIDIgOiBySW5pdGlhbDtcclxuICAgIGxldCBoID0gTWF0aC5hYnMoZXkgLSB5KSAvIDIgLSByO1xyXG4gICAgbGV0IHcgPSBNYXRoLmFicyhleCAtIHgpIC0gciAqIDI7XHJcblxyXG4gICAgLy8gQnVpbGQgdGhlIHBhdGhcclxuICAgIGNvbnN0IHBhdGggPSBgXHJcbiAgICAgICAgICAgIE0gJHt4fSAke3l9XHJcbiAgICAgICAgICAgIEwgJHt4fSAke3kgKyBoICogeXJ2c31cclxuICAgICAgICAgICAgQyAgJHt4fSAke3kgKyBoICogeXJ2cyArIHIgKiB5cnZzfSAke3h9ICR7eSArIGggKiB5cnZzICsgciAqIHlydnN9ICR7eCArIHIgKiB4cnZzfSAke3kgKyBoICogeXJ2cyArIHIgKiB5cnZzfVxyXG4gICAgICAgICAgICBMICR7eCArIHcgKiB4cnZzICsgciAqIHhydnN9ICR7eSArIGggKiB5cnZzICsgciAqIHlydnN9XHJcbiAgICAgICAgICAgIEMgJHtleH0gICR7eSArIGggKiB5cnZzICsgciAqIHlydnN9ICR7ZXh9ICAke3kgKyBoICogeXJ2cyArIHIgKiB5cnZzfSAke2V4fSAke2V5IC0gaCAqIHlydnN9XHJcbiAgICAgICAgICAgIEwgJHtleH0gJHtleX1cclxuICAgICAgICAgIGBcclxuICAgIC8vIFJldHVybiByZXN1bHRcclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxuXHJcbiAgZXhwYW5kKG5vZGU6IGQzLkhpZXJhcmNoeVBvaW50Tm9kZTxJRDNOb2RlPikge1xyXG4gICAgY29uc3QgbWUgPSB0aGlzO1xyXG4gICAgY29uc3QgZXhwYW5kZWQgPSBub2RlLmRhdGEuZXhwYW5kZWQ7XHJcbiAgICBub2RlLmRhdGEuZXhwYW5kZWQgPSAhZXhwYW5kZWQ7XHJcblxyXG4gICAgY29uc3QgZXhwYW5kID0gKGNoaWxkcmVuOiBkMy5IaWVyYXJjaHlQb2ludE5vZGU8SUQzTm9kZT5bXSwgZXhwYW5kZWQ6IGJvb2xlYW4pID0+IHtcclxuICAgICAgKGNoaWxkcmVuIHx8IFtdKVxyXG4gICAgICAgIC5mb3JFYWNoKGN1cnJlbnQgPT4ge1xyXG4gICAgICAgICAgY3VycmVudC5kYXRhLmhpZGRlbiA9ICFleHBhbmRlZDtcclxuICAgICAgICAgIGV4cGFuZChjdXJyZW50LmNoaWxkcmVuLCBleHBhbmRlZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwYW5kKG5vZGUuY2hpbGRyZW4sIGV4cGFuZGVkKTtcclxuICAgIG1lLnJlbmRlcigpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19